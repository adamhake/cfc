[build]
  # Build from monorepo root using Turborepo
  package = "apps/web"
  command = "pnpm install --frozen-lockfile && pnpm run build --filter=@chimborazo/web"
  publish = "apps/web/dist/client"
  ignore = "git diff --quiet $CACHED_COMMIT_REF $COMMIT_REF -- apps/web packages/sanity-config"

[build.environment]
  NODE_VERSION = "24"
  PNPM_FLAGS = "--frozen-lockfile --prefer-offline"

# Allow Sanity Studio to embed the site in an iframe (Presentation tool)
[[headers]]
  for = "/*"
  [headers.values]
    Content-Security-Policy = "frame-ancestors 'self' https://chimborazo-park-conservancy.sanity.studio https://studio.chimborazoparkconservancy.org https://*.sanity.build"

# Cache PostHog static assets (JS SDK files) for 1 year
[[headers]]
  for = "/ph/static/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# PostHog reverse proxy â€” static assets rule must come before the catch-all
[[redirects]]
  from = "/ph/static/*"
  to = "https://us-assets.i.posthog.com/static/:splat"
  host = "us-assets.i.posthog.com"
  status = 200
  force = true

[[redirects]]
  from = "/ph/*"
  to = "https://us.i.posthog.com/:splat"
  host = "us.i.posthog.com"
  status = 200
  force = true
